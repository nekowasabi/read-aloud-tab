# Process20: E2Eテスト手順書

## 概要
AI要約・翻訳機能のE2Eテストを実施するための詳細な手順書です。

---

## 前提条件

### 必須
- ✅ Chrome拡張機能ビルド完了（`dist/chrome`）
- ✅ Firefox拡張機能ビルド完了（`dist/firefox`）
- 🔑 OpenRouter APIキーの取得（https://openrouter.ai/）

### 推奨テスト環境
- Chrome: バージョン 120以降
- Firefox: バージョン 115以降
- テスト用の長文英語記事（例: Wikipedia、Medium、技術ブログ）

---

## Sub1: Chrome拡張機能のビルドとインストール

### ✅ ビルド完了
```bash
npm run build:chrome
# ✅ webpack compiled successfully
```

### インストール手順

1. **Chromeを開く**
   ```
   chrome://extensions/
   ```

2. **デベロッパーモードを有効化**
   - 右上の「デベロッパーモード」トグルをON

3. **拡張機能を読み込む**
   - 「パッケージ化されていない拡張機能を読み込む」をクリック
   - `/home/takets/repos/read-aloud-tab/dist/chrome` フォルダを選択

4. **インストール確認**
   - 拡張機能一覧に「Read Aloud Tab」が表示される
   - アイコンが表示される（ツールバーにピン留め推奨）

### トラブルシューティング
- **エラー「Manifest version 3 is required」**: ビルドが正しく完了しているか確認
- **Service Workerエラー**: Chrome DevToolsで Service Worker を確認

---

## Sub2: 要約のみモードのテスト

### 🎯 目的
AI要約機能のみが有効な場合、タブコンテンツを要約して読み上げることを確認

### 手順

#### 1. 設定画面を開く
- 拡張機能アイコンを右クリック → 「オプション」
- または `chrome://extensions/` → Read Aloud Tab → 「詳細」 → 「拡張機能のオプション」

#### 2. AI設定を行う
- **OpenRouter APIキー**: 取得したAPIキーを入力
- **OpenRouter モデル**: `meta-llama/llama-3.2-1b-instruct`（デフォルト）
- **AI要約を有効**: ✅ チェック
- **AI翻訳を有効**: ❌ チェックを外す

#### 3. 設定を保存
- 「設定をテスト」ボタンをクリック → 「接続に成功しました」を確認

#### 4. テスト用ページを開く
推奨ページ例:
- https://en.wikipedia.org/wiki/Artificial_intelligence
- https://en.wikipedia.org/wiki/Machine_learning
- 長文の英語技術ブログ

#### 5. 読み上げを実行
- 拡張機能アイコンをクリック → ポップアップを開く
- 「現在のタブを追加」ボタンをクリック
- 「再生」ボタンをクリック

#### 6. 検証ポイント
- ✅ タブがキューに追加される
- ✅ AI処理のインジケーター（ローディング状態）が表示される（数秒間）
- ✅ 元の長文ではなく、**要約された短い内容**が読み上げられる
- ✅ 読み上げられる内容は**英語**のまま（翻訳されていない）
- ✅ エラーが発生しない

### 期待される動作
- 元のページが5000語の記事でも、要約により500語程度に短縮される
- 主要なポイントが含まれた簡潔な要約が読み上げられる

---

## Sub3: 翻訳のみモードのテスト

### 🎯 目的
AI翻訳機能のみが有効な場合、タブコンテンツを日本語に翻訳して読み上げることを確認

### 手順

#### 1. 設定画面を開く（Sub2と同様）

#### 2. AI設定を変更
- **AI要約を有効**: ❌ チェックを外す
- **AI翻訳を有効**: ✅ チェック

#### 3. 設定を保存（Sub2と同様）

#### 4. テスト用ページを開く（Sub2と同様）
- 新しいタブで開くか、既存のタブをリロード

#### 5. 読み上げを実行
- キューをクリア（既存のタブを削除）
- 「現在のタブを追加」ボタンをクリック
- 「再生」ボタンをクリック

#### 6. 検証ポイント
- ✅ タブがキューに追加される
- ✅ AI処理のインジケーターが表示される（数秒間）
- ✅ **日本語**で読み上げられる
- ✅ 元の英語テキストの全文が翻訳されている（要約されていない）
- ✅ 翻訳の品質が自然で意味が通る

### 期待される動作
- 長文の英語記事が全文日本語に翻訳される
- 専門用語も適切に翻訳される

---

## Sub4: 要約+翻訳モードのテスト

### 🎯 目的
両方の機能が有効な場合、要約→翻訳の順で処理され、日本語の要約が読み上げられることを確認

### 手順

#### 1. 設定画面を開く（Sub2と同様）

#### 2. AI設定を変更
- **AI要約を有効**: ✅ チェック
- **AI翻訳を有効**: ✅ チェック

#### 3. 設定を保存（Sub2と同様）

#### 4. テスト用ページを開く（Sub2と同様）
- 長文の英語記事を推奨（5000語以上）

#### 5. 読み上げを実行
- キューをクリア
- 「現在のタブを追加」ボタンをクリック
- 「再生」ボタンをクリック

#### 6. 検証ポイント
- ✅ タブがキューに追加される
- ✅ AI処理のインジケーターが表示される（他のモードより時間がかかる可能性あり）
- ✅ **日本語**で読み上げられる
- ✅ 読み上げられる内容は**要約された短い内容**
- ✅ 要約の品質が高く、主要なポイントが含まれる

### 期待される動作
- 処理順序: 英語長文 → 英語要約 → 日本語要約
- 最も効率的な読み上げモード（短く、理解しやすい）

### 比較検証
Sub2（要約のみ）とSub3（翻訳のみ）の結果を比較：
- Sub2の要約内容を日本語にしたものと、Sub4の結果がほぼ一致するはず
- Sub4の方がSub3より大幅に短い読み上げ時間

---

## Sub5: エラーハンドリングのテスト

### 🎯 目的
API失敗時もアプリケーションがクラッシュせず、元のコンテンツで動作することを確認

### テストケース1: 無効なAPIキー

#### 手順
1. 設定画面を開く
2. **無効なAPIキー**を入力（例: `sk-invalid-key-12345`）
3. AI要約・翻訳を有効にする
4. 設定を保存（「設定をテスト」でエラーが表示される可能性）
5. テスト用ページで読み上げを実行

#### 検証ポイント
- ✅ アプリケーションがクラッシュしない
- ✅ エラーメッセージが表示される（または警告ログ）
- ✅ **元の英語コンテンツ**がそのまま読み上げられる（フォールバック）
- ✅ キューから削除されない（再試行可能）

### テストケース2: ネットワークエラー（オプション）

#### 手順
1. 有効なAPIキーを設定
2. ネットワークを一時的に切断（Wi-Fiオフなど）
3. 読み上げを実行
4. ネットワークを再接続

#### 検証ポイント
- ✅ タイムアウトエラーが適切に処理される
- ✅ 元のコンテンツで読み上げが続行される

### テストケース3: 空のコンテンツ

#### 手順
1. ほとんどテキストがないページを開く（例: 画像のみのページ）
2. 読み上げを実行

#### 検証ポイント
- ✅ 「コンテンツが見つかりません」などのエラーメッセージ
- ✅ アプリケーションがクラッシュしない

---

## Sub6: Firefox拡張機能のテスト

### ✅ ビルド完了
```bash
npm run build:firefox
# ✅ webpack compiled successfully
```

### インストール手順

1. **Firefoxを開く**
   ```
   about:debugging
   ```

2. **「このFirefox」を選択**

3. **一時的なアドオンを読み込む**
   - 「一時的なアドオンを読み込む」ボタンをクリック
   - `/home/takets/repos/read-aloud-tab/dist/firefox/manifest.json` を選択

4. **インストール確認**
   - アドオン一覧に「Read Aloud Tab」が表示される
   - ツールバーにアイコンが表示される

### テスト実施
**Sub2～Sub5と同じテストを実施**

#### Firefox特有の検証ポイント
- ✅ バックグラウンドスクリプトが`persistent: true`で動作
- ✅ Web Speech APIが正常に動作（ChromeのOffscreen APIは使用しない）
- ✅ AI要約・翻訳機能がChromeと同様に動作
- ✅ ストレージ同期が正常に動作

### Chrome版との比較
- 機能的な差異がないことを確認
- 音声の品質やパフォーマンスを比較

---

## テスト結果チェックリスト

### ✅ Chrome
- [ ] Sub1: ビルドとインストール成功
- [ ] Sub2: 要約のみモード動作確認
- [ ] Sub3: 翻訳のみモード動作確認
- [ ] Sub4: 要約+翻訳モード動作確認
- [ ] Sub5: エラーハンドリング確認

### ✅ Firefox
- [ ] Sub6: ビルドとインストール成功
- [ ] Sub6: 要約のみモード動作確認
- [ ] Sub6: 翻訳のみモード動作確認
- [ ] Sub6: 要約+翻訳モード動作確認
- [ ] Sub6: エラーハンドリング確認

---

## トラブルシューティング

### 問題: AI処理が実行されない
- **確認**: APIキーが正しく設定されているか
- **確認**: インターネット接続が正常か
- **確認**: ブラウザのコンソールでエラーログを確認（Service Worker / Background Script）

### 問題: 読み上げが開始されない
- **確認**: ブラウザの音声合成が有効か（`speechSynthesis.getVoices()`で確認）
- **確認**: タブにテキストコンテンツが存在するか
- **確認**: ポップアップのステータス表示を確認

### 問題: 翻訳・要約の品質が低い
- **対策**: より高性能なモデルを試す（例: `anthropic/claude-3-haiku`）
- **対策**: maxTokensを調整（設定画面で変更可能にする場合）

### 問題: 処理が遅い
- **確認**: OpenRouter APIのレート制限に達していないか
- **確認**: コンテンツが長すぎないか（5000文字以上は事前にトリミング）

---

## 次のステップ

### テスト完了後
1. **PLAN.mdを更新**: process20の全チェックボックスを完了にマーク
2. **テスト結果を記録**: 成功・失敗の詳細をドキュメント化
3. **Issue登録**: 発見されたバグや改善点をGitHub Issueに登録

### 今後の改善案
- AI処理のキャンセル機能
- 処理進捗のリアルタイム表示
- モデル選択UI（オプション画面）
- キャッシュ機能の強化（同じページを再度開いた場合）

---

## 付録: OpenRouter APIキーの取得方法

1. **OpenRouterに登録**: https://openrouter.ai/
2. **APIキーを生成**: Dashboard → API Keys → Create API Key
3. **使用量を確認**: 無料枠またはクレジット購入
4. **セキュリティ**: APIキーは絶対に公開リポジトリにコミットしない

---

**テスト実施者**: _________
**テスト日**: _________
**結果**: ✅ 成功 / ❌ 失敗 / ⚠️ 部分的成功
