# リファクタリング実施チェックリスト

このチェックリストは、リファクタリング計画の各Phaseを実施する際のガイドラインです。

---

## Phase 1: 基盤整備

### Task 1.1: 共通インターフェースの整理 ⬜

#### 準備
- [ ] 現在の型定義を全て洗い出し
- [ ] 型の依存関係をマッピング
- [ ] 循環依存を特定

#### 実装
- [ ] `src/shared/types/queue.ts` を作成
- [ ] `src/shared/types/tts.ts` を作成
- [ ] `src/shared/types/messaging.ts` を作成
- [ ] 既存型定義を適切なファイルに移動
- [ ] 不要な型定義を削除

#### 検証
- [ ] TypeScriptコンパイルエラーがないことを確認
- [ ] 既存のテストが全てパス
- [ ] IDE補完が正しく動作

#### ドキュメント
- [ ] JSDocコメントを追加
- [ ] 型の使用例を記載
- [ ] CLAUDE.mdを更新

---

### Task 1.2: ユーティリティ関数の統合 ⬜

#### 準備
- [ ] 現在のエラーハンドリングパターンを調査
- [ ] ロギング呼び出しを全て洗い出し
- [ ] 重複コードを特定

#### 実装
- [ ] `src/shared/utils/errorHandler.ts` を作成
  - [ ] `ErrorHandler.handle()` メソッド
  - [ ] `ErrorHandler.createError()` メソッド
  - [ ] `ErrorHandler.wrapAsync()` メソッド
- [ ] `src/shared/utils/logger.ts` を作成
  - [ ] `Logger.create()` メソッド
  - [ ] `Logger.setLevel()` メソッド
  - [ ] ログレベルの実装
- [ ] 既存コードを新しいユーティリティに置き換え

#### 検証
- [ ] 全テストがパス
- [ ] エラーログの一貫性を確認
- [ ] パフォーマンス影響がないことを確認

#### ドキュメント
- [ ] 使用例を追加
- [ ] エラーコード一覧を作成

---

## Phase 2: service.ts のリファクタリング

### Task 2.1: メッセージハンドラーの分離 ⬜

#### 準備
- [ ] 現在のメッセージタイプを全て洗い出し
- [ ] メッセージハンドリングのフローを図解
- [ ] 責任分離の設計を完成

#### 実装
- [ ] `src/background/messaging/` ディレクトリ作成
- [ ] `MessageRouter.ts` を実装
  - [ ] `registerHandler()` メソッド
  - [ ] `handleMessage()` メソッド
  - [ ] エラーハンドリング
- [ ] 個別ハンドラーを実装
  - [ ] `QueueMessageHandler.ts`
  - [ ] `TTSMessageHandler.ts`
  - [ ] `AIMessageHandler.ts`
  - [ ] `SettingsMessageHandler.ts`
- [ ] `service.ts` を更新して新しいRouterを使用

#### 検証
- [ ] 全メッセージタイプが正しく処理されることを確認
- [ ] パフォーマンステスト実施
- [ ] エッジケースのテスト追加

#### ドキュメント
- [ ] メッセージフロー図を更新
- [ ] 各ハンドラーの責任を文書化

---

### Task 2.2: Keep-alive管理の独立化 ⬜

#### 準備
- [ ] Chrome/Firefox両方のKeep-alive要件を整理
- [ ] 現在の実装を分析
- [ ] インターフェース設計を完成

#### 実装
- [ ] `src/background/keepalive/` ディレクトリ作成
- [ ] `KeepAliveStrategy.ts` インターフェースを定義
- [ ] `ChromeKeepAlive.ts` を実装
  - [ ] ポート接続管理
  - [ ] ハートビート送信
  - [ ] 再接続ロジック
- [ ] `FirefoxKeepAlive.ts` を実装（no-op）
- [ ] `service.ts` から既存ロジックを移行

#### 検証
- [ ] Chrome環境でのテスト
- [ ] Firefox環境でのテスト
- [ ] 長時間動作テスト（60分以上）
- [ ] メトリクス収集の確認

#### ドキュメント
- [ ] ブラウザ別の動作を文書化
- [ ] トラブルシューティングガイド更新

---

### Task 2.3: Offscreen Document管理の改善 ⬜

#### 準備
- [ ] Offscreen APIの制約を再確認
- [ ] ライフサイクルイベントを整理
- [ ] 責任分離の設計を完成

#### 実装
- [ ] `OffscreenManager.ts` を作成
  - [ ] `create()` メソッド
  - [ ] `destroy()` メソッド
  - [ ] `isActive()` メソッド
  - [ ] `sendCommand()` メソッド
- [ ] `offscreen.ts` をリファクタリング
  - [ ] TTS処理に専念
  - [ ] ライフサイクル管理を委譲
- [ ] `service.ts` を更新

#### 検証
- [ ] Offscreenの作成/破棄テスト
- [ ] コマンド送信テスト
- [ ] エラーハンドリングテスト

#### ドキュメント
- [ ] Offscreenアーキテクチャを文書化
- [ ] Chrome固有の制約を明記

---

## Phase 3: tabManager.ts のリファクタリング

### Task 3.1: キュー管理の責任分離 ⬜

#### 準備
- [ ] 現在のキュー操作を全て洗い出し
- [ ] 状態遷移を図解
- [ ] Immutableパターンの設計

#### 実装
- [ ] `src/background/queue/` ディレクトリ作成
- [ ] `QueueState.ts` を実装
  - [ ] 基本操作（add/remove/move）
  - [ ] Immutable operations
  - [ ] 状態検証ロジック
- [ ] `QueueEventEmitter.ts` を実装
  - [ ] イベント登録/解除
  - [ ] 型安全なイベント発行
- [ ] `tabManager.ts` をリファクタリング

#### 検証
- [ ] 状態遷移の正確性テスト
- [ ] イベント発行のテスト
- [ ] 並行性テスト

#### ドキュメント
- [ ] 状態遷移図を作成
- [ ] イベントカタログを作成

---

### Task 3.2: ストレージ層の抽象化 ⬜

#### 準備
- [ ] 現在のストレージアクセスパターンを調査
- [ ] リポジトリパターンの設計
- [ ] テスト戦略の策定

#### 実装
- [ ] `QueueRepository.ts` インターフェース定義
- [ ] `ChromeStorageQueueRepository.ts` 実装
- [ ] `InMemoryQueueRepository.ts` 実装（テスト用）
- [ ] `tabManager.ts` を更新
- [ ] デバウンス処理の統合

#### 検証
- [ ] 実際のストレージとの連携テスト
- [ ] メモリ実装でのテスト
- [ ] パフォーマンステスト

#### ドキュメント
- [ ] リポジトリパターンの説明
- [ ] ストレージ制約の文書化

---

### Task 3.3: コンテンツ解決の責任分離 ⬜

#### 準備
- [ ] コンテンツ取得の全パターンを洗い出し
- [ ] AI処理との連携を設計
- [ ] プリフェッチとの統合を設計

#### 実装
- [ ] `src/background/content/` ディレクトリ作成
- [ ] `ContentResolver.ts` を実装
- [ ] `ContentFetcher.ts` を実装
  - [ ] タブからの取得
  - [ ] コンテンツ抽出
- [ ] `tabManager.ts` を更新

#### 検証
- [ ] 各コンテンツソースのテスト
- [ ] AI処理との連携テスト
- [ ] プリフェッチとの統合テスト

#### ドキュメント
- [ ] コンテンツ解決フローを文書化
- [ ] 優先順位ロジックを説明

---

## Phase 4: ttsEngine.ts のリファクタリング

### Task 4.1: チャンク管理の分離 ⬜

#### 準備
- [ ] チャンク処理のフローを図解
- [ ] RxJS処理の分離ポイントを特定
- [ ] リトライ戦略を設計

#### 実装
- [ ] `src/background/tts/` ディレクトリ作成
- [ ] `ChunkPlayer.ts` を実装
- [ ] `ChunkTransitionStrategy.ts` を実装
  - [ ] RxJSベースの実装
  - [ ] リトライロジック
- [ ] `ttsEngine.ts` をリファクタリング

#### 検証
- [ ] チャンク遷移のテスト
- [ ] リトライ動作のテスト
- [ ] 長時間読み上げテスト

#### ドキュメント
- [ ] チャンク処理アーキテクチャを文書化
- [ ] パフォーマンス特性を記載

---

### Task 4.2: 音声選択の改善 ⬜

#### 準備
- [ ] 音声取得の問題点を整理
- [ ] リトライ戦略を設計
- [ ] キャッシュ戦略を設計

#### 実装
- [ ] `VoiceManager.ts` を作成
  - [ ] 音声リスト取得（リトライ付き）
  - [ ] 音声選択ロジック
  - [ ] キャッシュ管理
- [ ] `ttsEngine.ts` を更新
- [ ] `voiceSelector.ts` との統合

#### 検証
- [ ] Firefox AMO環境でのテスト
- [ ] Chrome環境でのテスト
- [ ] 音声切り替えテスト

#### ドキュメント
- [ ] 音声選択フローを文書化
- [ ] ブラウザ別の制約を明記

---

## Phase 5: UI層のリファクタリング

### Task 5.1: コンポーネントの分割 ⬜

#### 準備
- [ ] 現在のコンポーネント構造を分析
- [ ] 状態管理戦略を設計
- [ ] コンポーネント分割計画を作成

#### 実装
- [ ] `src/popup/context/QueueContext.tsx` を作成
- [ ] カスタムフックの統合
  - [ ] `useQueueOperations.ts`
  - [ ] `usePlaybackControl.ts`
- [ ] `App.tsx` をリファクタリング
- [ ] 新規コンポーネントの作成

#### 検証
- [ ] UIの動作確認
- [ ] React Testing Libraryでのテスト
- [ ] アクセシビリティテスト

#### ドキュメント
- [ ] コンポーネント構造図を作成
- [ ] Props/State設計を文書化

---

### Task 5.2: 設定画面の改善 ⬜

#### 準備
- [ ] フォーム管理ライブラリの検討（React Hook Form等）
- [ ] バリデーション戦略の設計
- [ ] コンポーネント分割計画

#### 実装
- [ ] 設定セクションのコンポーネント化
  - [ ] `TTSSettingsSection.tsx`
  - [ ] `AISettingsSection.tsx`
  - [ ] `IgnoreListSection.tsx`
- [ ] フォーム管理の統合
- [ ] `OptionsApp.tsx` をリファクタリング

#### 検証
- [ ] フォームバリデーションテスト
- [ ] 設定保存テスト
- [ ] UIテスト

#### ドキュメント
- [ ] 設定項目の説明を更新
- [ ] バリデーションルールを文書化

---

## Phase 6: テスト強化

### Task 6.1: 単体テストの追加 ⬜

#### 準備
- [ ] カバレッジレポートを分析
- [ ] テスト優先順位を決定
- [ ] モック戦略を統一

#### 実装
- [ ] `src/tests/mocks/` ディレクトリ作成
  - [ ] `mockBrowser.ts`
  - [ ] `mockStorage.ts`
  - [ ] `mockSpeechSynthesis.ts`
- [ ] 新規クラスのテスト追加
- [ ] エッジケーステストの追加
- [ ] カバレッジ75%達成

#### 検証
- [ ] 全テストの実行
- [ ] カバレッジレポート確認
- [ ] CI/CDでの動作確認

#### ドキュメント
- [ ] テスト戦略を文書化
- [ ] モックの使い方ガイド作成

---

### Task 6.2: 統合テストの改善 ⬜

#### 準備
- [ ] 現在の統合テストを分析
- [ ] 改善ポイントを特定
- [ ] テストシナリオを整理

#### 実装
- [ ] テストデータの共通化
- [ ] 非同期処理の安定化
- [ ] テスト実行時間の最適化

#### 検証
- [ ] フレーキーテストの削減確認
- [ ] 実行時間の測定
- [ ] CI/CDでの安定性確認

#### ドキュメント
- [ ] テストシナリオを文書化
- [ ] トラブルシューティングガイド更新

---

## Phase 7: パフォーマンス最適化

### Task 7.1: メモリ使用量の最適化 ⬜

#### 準備
- [ ] メモリプロファイリング実施
- [ ] リーク箇所の特定
- [ ] 最適化戦略の策定

#### 実装
- [ ] イベントリスナーのクリーンアップ
- [ ] 不要なキャッシュの削除
- [ ] WeakMapの活用

#### 検証
- [ ] 長時間動作テスト
- [ ] メモリ使用量の測定
- [ ] リーク検出ツールでの確認

#### ドキュメント
- [ ] メモリ管理のベストプラクティスを文書化

---

### Task 7.2: バンドルサイズの削減 ⬜

#### 準備
- [ ] バンドル分析ツールの実行
- [ ] 大きな依存関係の特定
- [ ] 削減戦略の策定

#### 実装
- [ ] Tree-shakingの最適化
- [ ] 動的importの活用
- [ ] 不要な依存関係の削除

#### 検証
- [ ] バンドルサイズの測定
- [ ] 読み込み速度の測定
- [ ] 機能動作確認

#### ドキュメント
- [ ] バンドル最適化戦略を文書化

---

## 各Phase共通のチェック項目

### 実装前
- [ ] 詳細設計を作成
- [ ] テスト計画を作成
- [ ] レビュー担当者を決定

### 実装中
- [ ] TDDアプローチを実践
- [ ] コミットメッセージを明確に
- [ ] 定期的なプッシュ

### 実装後
- [ ] 全テストが成功
- [ ] TypeScriptエラーなし
- [ ] ESLint/Prettierエラーなし
- [ ] コードレビュー完了
- [ ] ドキュメント更新完了

### Phase完了時
- [ ] 成功基準を達成
- [ ] マイルストーン達成を確認
- [ ] 次Phaseの影響を評価
- [ ] 振り返りを実施

---

## 進捗管理

### 完了したPhase
- ⬜ Phase 1: 基盤整備
- ⬜ Phase 2: service.tsリファクタリング
- ⬜ Phase 3: tabManager.tsリファクタリング
- ⬜ Phase 4: ttsEngine.tsリファクタリング
- ⬜ Phase 5: UI層リファクタリング
- ⬜ Phase 6: テスト強化
- ⬜ Phase 7: パフォーマンス最適化

### マイルストーン
- ⬜ M1: Phase 1完了
- ⬜ M2: Phase 2-3完了
- ⬜ M3: Phase 4-5完了
- ⬜ M4: Phase 6-7完了（リリース）

---

**最終更新**: 2025-10-28  
**次回レビュー**: Phase 1開始時
